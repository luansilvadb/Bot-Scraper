// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BotStatus {
  ACTIVE
  PAUSED
  ERROR
}

enum ProductStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  POSTED
}

model Bot {
  id            String           @id @default(uuid())
  name          String
  targetUrl     String
  affiliateTag  String
  telegramToken String
  chatId        String
  scheduleCron  String
  status        BotStatus        @default(ACTIVE)
  products      ScrapedProduct[]
  createdAt     DateTime         @default(now())
}

model ScrapedProduct {
  id                 String        @id @default(uuid())
  asin               String        @unique
  title              String
  currentPrice       Float
  originalPrice      Float
  discountPercentage Int
  imageUrl           String
  productUrl         String
  status             ProductStatus @default(PENDING_APPROVAL)
  botId              String?
  bot                Bot?          @relation(fields: [botId], references: [id])
  foundAt            DateTime      @default(now())
  expiresAt          DateTime?
}

model SystemSetting {
  key   String @id
  value String
}

// ===== Local Worker Scraper Feature =====

enum WorkerStatus {
  DISCONNECTED
  CONNECTED
  BUSY
  BLOCKED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  PERMANENTLY_FAILED
}

model LocalWorker {
  id                  String       @id @default(uuid())
  name                String       @db.VarChar(100)
  token               String       @unique
  ispName             String?      @db.VarChar(50)
  externalIp          String?      @db.VarChar(45)
  status              WorkerStatus @default(DISCONNECTED)
  lastHeartbeatAt     DateTime?
  tasksCompletedCount Int          @default(0)
  tasksFailedCount    Int          @default(0)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  tasks ScrapingTask[]

  @@index([status])
}

model ScrapingTask {
  id               String     @id @default(uuid())
  productUrl       String     @db.VarChar(2048)
  status           TaskStatus @default(PENDING)
  priority         Int        @default(0)
  attemptCount     Int        @default(0)
  maxAttempts      Int        @default(3)
  assignedWorkerId String?
  errorType        String?    @db.VarChar(50)
  errorMessage     String?
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  assignedWorker LocalWorker?   @relation(fields: [assignedWorkerId], references: [id])
  result         ScrapingResult?

  @@index([status])
  @@index([assignedWorkerId])
  @@index([status, priority, createdAt])
}

model ScrapingResult {
  id            String   @id @default(uuid())
  taskId        String   @unique
  productTitle  String   @db.VarChar(500)
  price         Decimal? @db.Decimal(10, 2)
  currency      String   @default("BRL") @db.VarChar(3)
  originalPrice Decimal? @db.Decimal(10, 2)
  rating        Decimal? @db.Decimal(2, 1)
  reviewCount   Int?
  availability  String?
  isAvailable   Boolean  @default(true)
  imageUrls     String[] @default([])
  asin          String?  @db.VarChar(20)
  scrapedAt     DateTime @default(now())
  createdAt     DateTime @default(now())

  task ScrapingTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([asin])
  @@index([scrapedAt])
}
